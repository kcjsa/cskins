<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Skin配布サイト</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 1rem; }
    form { margin-bottom: 2rem; }
    label { display: block; margin-top: 1rem; }
    input[type="text"], input[type="url"] {
      width: 100%; padding: 0.5rem; font-size: 1rem;
    }
    button { margin-top: 1rem; padding: 0.5rem 1rem; font-size: 1rem; }
    .skin-item { margin-bottom: 1rem; border-bottom: 1px solid #ccc; padding-bottom: 1rem; }
    img { max-width: 120px; max-height: 120px; vertical-align: middle; }
    .skin-info { display: inline-block; margin-left: 1rem; vertical-align: middle; }
    a.download-link { margin-left: 1rem; color: blue; text-decoration: underline; }
  </style>
</head>
<body>

<h1>Skin投稿フォーム</h1>

<form id="skinForm">
  <label>
    投稿者名（任意）
    <input type="text" id="user" placeholder="匿名でもOK" />
  </label>
  <label>
    表示用画像URL
    <input type="url" id="displayUrl" placeholder="例: https://drive.google.com/..." required />
  </label>
  <label>
    ダウンロード用URL
    <input type="url" id="downloadUrl" placeholder="例: https://drive.google.com/...?dl=1" required />
  </label>
  <button type="submit">投稿する</button>
</form>

<h2>投稿済みSkin一覧</h2>
<div id="skinList">
  <!-- ここに投稿一覧が表示される -->
</div>

<script>
  const apiUrl = '【あなたのGASデプロイURLをここに貼ってください】';

  const form = document.getElementById('skinForm');
  const skinList = document.getElementById('skinList');

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const user = document.getElementById('user').value.trim() || '匿名';
    const displayUrl = document.getElementById('displayUrl').value.trim();
    const downloadUrl = document.getElementById('downloadUrl').value.trim();

    if (!displayUrl || !downloadUrl) {
      alert('URLは必須です');
      return;
    }

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, url: downloadUrl, displayUrl, downloadUrl })
      });
      const text = await res.text();
      const json = JSON.parse(text);

      if (json.result === 'success') {
        alert('投稿成功！');
        form.reset();
        loadSkins();
      } else {
        alert('投稿失敗: ' + (json.error || '不明なエラー'));
      }
    } catch (err) {
      alert('通信エラー: ' + err.message);
    }
  });

  async function loadSkins() {
    skinList.innerHTML = '読み込み中...';
    try {
      const res = await fetch(apiUrl);
      const text = await res.text();
      const data = JSON.parse(text);

      if (!Array.isArray(data)) {
        skinList.textContent = 'データ取得エラー';
        return;
      }

      if (data.length === 0) {
        skinList.textContent = 'まだ投稿がありません。';
        return;
      }

      skinList.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'skin-item';

        const img = document.createElement('img');
        img.src = item.displayUrl;
        img.alt = `Skin by ${item.user}`;
        div.appendChild(img);

        const info = document.createElement('div');
        info.className = 'skin-info';
        info.textContent = `投稿者: ${item.user} / 投稿日: ${new Date(item.timestamp).toLocaleString()}`;
        div.appendChild(info);

        const link = document.createElement('a');
        link.href = item.downloadUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = '[ダウンロード]';
        link.className = 'download-link';
        div.appendChild(link);

        skinList.appendChild(div);
      });
    } catch (err) {
      skinList.textContent = '一覧の読み込みに失敗しました。';
      console.error(err);
    }
  }

  // ページ読み込み時に一覧を取得
  loadSkins();
</script>

</body>
</html>
